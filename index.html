<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MIDCARE – 2014-Initialised Model</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
</head>

<body>

<h2>PHI vs Medical Card Coverage (Model initialised in 2014)</h2>

<button id="runBtn">Run from 2024</button>
<button id="resetBtn">Reset</button>

<canvas id="coverageChart"></canvas>
<canvas id="ratioChart"></canvas>
<canvas id="allocationChart"></canvas>

<script>
/* ------------------ MODEL SETTINGS ------------------ */

const INITIAL_TIME = 2014;
const HIST_END_YEAR = 2023;   // calibration window 2014–2023
const FINAL_TIME = 2050;

/* 2014–2024 historical observations */

const histYears = [
  2014,2015,2016,2017,2018,2019,2020,2021,2022,2023,2024
];

const histPriv = [
  41.7,42.1,42.4,43.5,45.2,45.7,46.1,46.7,47.2,47.0,46.0
];

const histPub = [
  38.1,37.0,35.5,32.9,32.2,31.2,31.5,30.4,30.2,30.5,29.0
];

/* maps for lookup */
const histPrivMap = {};
const histPubMap = {};
histYears.forEach((y,i)=>{ 
  histPrivMap[y]=histPriv[i]; 
  histPubMap[y]=histPub[i]; 
});

let years=[];
for(let y=INITIAL_TIME;y<=FINAL_TIME;y++) years.push(y);

/* ------------------ SUCCESS LOOKUP ------------------ */

const lookupPoints=[
 {x:0,y:0},{x:0.1,y:0.05},{x:0.2,y:0.1},{x:0.3,y:0.2},{x:0.4,y:0.3},
 {x:0.45,y:0.4},{x:0.5,y:0.5},{x:0.55,y:0.6},{x:0.6,y:0.7},{x:0.65,y:0.85},
 {x:0.7,y:0.9},{x:0.8,y:0.95},{x:0.9,y:1},{x:1,y:1}
];

function lookup(v){
 if(v<=0)return 0;
 if(v>=1)return 1;
 for(let i=0;i<lookupPoints.length-1;i++){
  const a=lookupPoints[i],b=lookupPoints[i+1];
  if(v>=a.x&&v<=b.x){
   const f=(v-a.x)/(b.x-a.x);
   return a.y+f*(b.y-a.y);
  }
 }
}

/* ------------------ CHARTS ------------------ */

let covChart,ratioChart,allocChart,timer=null;

function init(){

 const cov=years.map(y=>y<=HIST_END_YEAR?histPrivMap[y]:null);
 const pub=years.map(y=>y<=HIST_END_YEAR?histPubMap[y]:null);

 const ratio=years.map(y=>{
   if(y<=HIST_END_YEAR){
     const t=histPrivMap[y]+histPubMap[y];
     return histPrivMap[y]/t;
   }
   return null;
 });

 covChart=new Chart(document.getElementById("coverageChart"),{
  type:'line',
  data:{labels:years,datasets:[
    {label:"Private Coverage %",data:cov,borderColor:"#0b1f63",pointRadius:0},
    {label:"Medical Card %",data:pub,borderColor:"#0d9488",pointRadius:0}
  ]},
  options:{scales:{y:{min:0,max:100}}}
 });

 ratioChart=new Chart(document.getElementById("ratioChart"),{
  type:'line',
  data:{labels:years,datasets:[
   {label:"Success Ratio (PHI Share)",data:ratio,borderColor:"#2563eb",pointRadius:0}
  ]},
  options:{scales:{y:{min:0,max:1}}}
 });

 const xs=[],ys=[];
 for(let i=0;i<=100;i++){xs.push(i/100);ys.push(lookup(i/100));}

 allocChart=new Chart(document.getElementById("allocationChart"),{
  type:'line',
  data:{labels:xs,datasets:[
   {label:"Allocation Lookup",data:ys,borderColor:"#0f766e",pointRadius:0}
  ]}
 });

 document.getElementById("runBtn").onclick=runFrom2024;
 document.getElementById("resetBtn").onclick=()=>location.reload();
}

/* ------------------ DYNAMIC SIMULATION ------------------ */

function runFrom2024(){

 if(timer)clearInterval(timer);

 let priv = histPrivMap[HIST_END_YEAR];
 let pub  = histPubMap[HIST_END_YEAR];

 let cov=covChart.data.datasets[0].data.slice();
 let pubc=covChart.data.datasets[1].data.slice();
 let rat=ratioChart.data.datasets[0].data.slice();

 let year=2024;

 timer=setInterval(()=>{

   if(year>FINAL_TIME){clearInterval(timer);return;}

   const tot=priv+pub;
   const r=priv/tot;
   const alloc=lookup(r);

   /* structural parameters consistent with Vensim */
   const R=1.0;
   const lambdaP=0.014;
   const lambdaM=0.024;

   const gainP=R*alloc;
   const gainM=R*(1-alloc);

   priv = priv + gainP - lambdaP*priv;
   pub  = pub  + gainM - lambdaM*pub;

   const idx=years.indexOf(year);
   cov[idx]=priv;
   pubc[idx]=pub;
   rat[idx]=priv/(priv+pub);

   covChart.data.datasets[0].data=cov;
   covChart.data.datasets[1].data=pubc;
   ratioChart.data.datasets[0].data=rat;

   covChart.update();
   ratioChart.update();

   year++;

 },200);
}

window.onload=init;
</script>

</body>
</html>

